## ✨ Лаба 3. Суперачивка. По логу посещений найти сайты, релевантные для определённой группы пользователей

##### [![New Professions Lab — Big Data 7](http://data.newprolab.com/public-newprolab-com/npl7.svg)](https://github.com/newprolab/content_bigdata7)

### Дедлайн

⏰ Воскресенье, 16 апреля 2018 года, 23:59.

### Задача

Когда мы знаем профили наших пользователей, встает другая задача - через какие площадки пытаться достучаться до них. Первое, что приходит в голову - известные тематические порталы, но размещение рекламы там может быть дорогим.

После чего появляется другая мысль: “А может быть, мы можем найти такие сайты, на которые ходят наши пользователи, но они не являются такими очевидными и следовательно могут быть дешевле?”

**Для выполнения работы мы снова рекомендуем использовать Apache Hive.**

#### Обработка данных на вход

Вы будете использовать тот же датасет, что и для Лабы 3: `/labs/lab03data` на HDFS.

Как и в лабе, возьмите все данные из указанной выше директории.

Исходные данные представлены логом посещений сайтов различными пользователями. Необходимо определить, насколько тот или иной домен является релевантным для категории пользователей “Автомобилисты”.

Перечень доменов для нее следующий:

```
cars.ru
avto-russia.ru
bmwclub.ru
```

Классификация на автомобилистов уже была проведена вами при выполнении Лабы 3.

#### Пояснение к классификации доменов:

Домены `market.ya.ru`, `super.market.ya.ru`, `ya.ru` считаются разными.
Домены `www.ya.ru` и `ya.ru` считаются одинаковыми.

Брать в рассмотрение только URL с `http://` и `https://`. Классифицировать только тех пользователей, у которых в качестве `id` есть непустое значение (прочерк считать пустым значением).

URL’ы в виде прочерка также не брать в рассмотрение.

Пример. 
Имеется следующий отрывок лога. Известно, что пользователи 123 и 789 являются автомобилистами.

```
UID	Timestamp	URL
123	1354546464.210	http%3A%2F%2Fwww.cars.ru%2Fsample-page-1
123	1354546464.211	http%3A%2F%2Fauto.ru%2Fsample-page-2
123	8452135545.123	http%3A%2F%2Fya.ru%2Fsample-page-1
456	1234564654.231	http%3A%2F%2Fwww.ya.ru%2Fsample-page-1
456	8452135545.123	http%3A%2F%2Fauto.ru%2Fsample-page-1
456	4568797889.549	http%3A%2F%2Fya.ru%2Fstart
456	4568797889.549	http%3A%2F%2Fmarket.ya.ru%2Fstart
789	1234564654.231	http%3A%2F%2Fwww.auto.ru%2Fsample-page-1
789	1354546464.211	http%3A%2F%2Fwww.cars.ru%2Fsample-page-2
789	4568797889.549	http%3A%2F%2Fya.ru%2Fstart
```

Из этого лога можно получить более простую таблицу, состоящую из домена и переменной, которая показывает, был ли посещен этот домен пользователем-автомобилистом.

```
URL	Auto-flag
cars.ru		1
auto.ru		1
ya.ru		1
ya.ru		0
auto.ru		0
ya.ru		0
market.ya.ru	0
auto.ru		1
cars.ru		1
ya.ru		1 
```

#### Обработка данных на выход

⚠️ Важно: Выходной файл должен быть расположен **НЕ в HDFS**, а в корне вашей домашней директории на мастер-ноде в файле `lab03s_domains.txt`. В выходном файле все домены должны быть без `www.` вначале.

Чекер будет брать файл именно оттуда.

Содержимое файла должно представлять собой список доменов релевантных для автомобилистов, упорядоченных по убыванию показателя релевантности, который рассчитывается следующим образом: ![tex1](http://data.newprolab.com/public-newprolab-com/lab03s_tex1.svg)

Это коэффициент Отиаи для двух проивольных множеств (в нашем случае: «Домен» и «Автомобилист»). Изначально он использовался в биологии (оценка встречаемости видов), но в дальнейшем распространился далеко за эти рамки. Если же рассматривать множества как [битовые карты](https://en.wikipedia.org/wiki/Bit_array) (грубо говоря, вектора), то наш коэффициент превращается в известную косинусную меру сходства.

В числителе стоит вероятность того, что наугад выбранная строка лога будет одновременно относиться к пользователю “Автомобилист” и интересующему домену, в квадрате. В знаменателе стоит произведение вероятности того, что наугад выбранная строка будет относиться к интересующему домену, и вероятности того, что наугад выбранная строка будет относиться к пользователю “Автомобилист”.
Таблица содержит два поля: `domain` и `relevance`.

На рассмотренном примере выходной файл будет следующим (второе поле представлено для лучшего понимания формулы расчета):

cars.ru: ![tex2](http://data.newprolab.com/public-newprolab-com/lab03s_tex2.svg)

auto.ru: ![tex3](http://data.newprolab.com/public-newprolab-com/lab03s_tex3.svg)

ya.ru: ![tex4](http://data.newprolab.com/public-newprolab-com/lab03s_tex4.svg)

market.ya.ru: ![tex5](http://data.newprolab.com/public-newprolab-com/lab03s_tex5.svg)

В выходном файле требуется список топ-200 доменов, по убыванию релевантности. 

Релевантность — это число, а не строка. В случае одинаковой релевантности, отсортировать по домену лексикографически в порядке возрастания. 

Разделитель между доменом и релевантностью — символ табуляции. Проверьте, что у вас разделителем является именно таб, а не несколько пробелов. Это типичная и очень обидная ошибка.

Релевантность нужна с 20 знаками после точки.

#### Подсказки

Для выделения домена из `url` можно воспользоваться той же самой функцией url2domain из описания lab03.

Пример правильной строчки из ответа:

`xn--80aakahknigpedfdm6u.xn--p1ai	0.00031373656935232430`

### Проверка

Проверка осуществляется автоматическим скриптом из Личного кабинета.
